#!usr/bin/env python
# -*- coding: utf-8 -*-

import os
import argparse
import sys
from pathlib import Path
import pkg_resources
from datetime import date

import numpy as np
import SimpleITK as sitk

from Methods.itkUtils import *
from Methods.utils import *
from Methods.majority_voting import *

def main():
  copyrightMessage = 'Contact: software@cbica.upenn.edu\n\n' + 'This program is NOT FDA/CE approved and NOT intended for clinical use.\nCopyright (c) ' + str(date.today().year) + ' University of Pennsylvania. All rights reserved.' 
  parser = argparse.ArgumentParser(prog='LabelFusion', formatter_class=argparse.RawTextHelpFormatter, description = "Fusion of different labels together.\n\n" + copyrightMessage)
  parser.add_argument('-inputs', type=str, help = 'The absolute, comma-separated paths of labels that need to be fused', required=True)
  parser.add_argument('-classes', type=str, help = 'The expected labels; for example, for BraTS, this should be \'0,1,2,4\'', required=True)
  parser.add_argument('-method', type=str, help = 'The method to apply; currently available: MajorityVoting | SIMPLE | STAPLE', required=True)
  parser.add_argument('-output', type=str, help = 'The output file to write the results', required=True)

  args = parser.parse_args()
  
  inputs = list(args.inputs.split(',')) # list of input file paths

  if len(inputs) < 2:
    sys.exit('Cannot perform fusion for less than 2 input labels')

  for i in range(1, len(inputs)):
    if not imageSanityCheck(inputs[0], inputs[i]):
      sys.exit('There is a mismatch between the physical definitions of the input labels, please check')

  class_list = list(args.classes.split(','))
  class_list_int = [int(i) for i in class_list]

  inputArrayOfOneHotEncodedMasks = []

  for i in range(0, len(inputs)):
    currentImageArray = sitk.GetArrayFromImage(sitk.ReadImage(inputs[i], sitk.sitkUInt8))
    currentImageArray_oneHot = one_hot_nonoverlap(currentImageArray, class_list_int)
    inputArrayOfOneHotEncodedMasks.append(currentImageArray_oneHot)

  fused_oneHot = majority_voting(inputArrayOfOneHotEncodedMasks)
  fused_segmentation = convert_to_3D(fused_oneHot, class_list_int)

  fused_image = sitk.GetImageFromArray(fused_segmentation)
  fused_image.CopyInformation(sitk.ReadImage(inputs[0], sitk.sitkUInt8))
  sitk.WriteImage(fused_image, args.output)


if __name__ == '__main__':
  main()
